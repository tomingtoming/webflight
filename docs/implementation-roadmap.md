# WebFlight実装ロードマップ

## 概要

YSFLIGHTリソース調査結果を基に、段階的なWebFlight実装戦略を定義します。MVP（最小限動作製品）から完全なYSFLIGHT互換性まで、5つのフェーズで構成されています。

## 現在の実装状況分析

### ✅ 既に実装済み
- **DNMModelParser**: DNMファイルの基本パース機能
- **AircraftManager**: 機体アセット管理システム
- **Three.js統合**: 3Dモデルのレンダリング基盤
- **フォールバック機能**: 機体が読み込めない場合の代替表示

### ⚠️ 現在の問題点
1. **SRFファイル処理**: 外部SRFファイル（cockpit、collision）の処理が不完全
2. **PCK形式対応**: 埋め込み表面データの抽出が未実装
3. **パフォーマンス**: フォールバック三角形化が非効率（4,585頂点→4,411,751ポリゴン）
4. **エラーハンドリング**: 存在しないファイルへの依存でエラーが頻発
5. **実動作確認**: 実際に動作する機体モデルが1つもない状況

### 🎯 戦略的アプローチ
問題を解決し、段階的に機能を構築するため、以下の5フェーズに分けて実装します。

---

## Phase 1: 基本モデル表示 - MVP達成 🚀

**目標**: 実在するSRFファイルを使用した最初の動作確認

### 📋 Phase 1 タスク

#### 1.1 SRFパーサーの独立実装
- [ ] `src/loaders/SRFModelParser.ts`を新規作成
- [ ] 外部SRFファイル（cockpit、collision）の基本パース機能
- [ ] Three.js BufferGeometryへの変換処理
- [ ] 基本的なエラーハンドリング

#### 1.2 動作確認可能な機体の特定
- [ ] 実在ファイルの組み合わせ調査（完全に存在するファイルセット）
- [ ] 推奨候補：
  - **Cessna 172R**: `cessna172r.dnm` + `cessna172_cockpit.srf` + `cessna172_collision.srf`
  - **F-16**: `f16.dnm` + `f16cockpit.srf` + `f16coll.srf`

#### 1.3 DNMModelParserの簡素化
- [ ] PCK処理を一時的にスキップ
- [ ] 複雑なフォールバック処理を削除
- [ ] `createSimpleTriangulation`をデフォルトに

#### 1.4 AircraftManagerの更新
- [ ] 実在ファイルベースの設定に更新
- [ ] エラー時の適切なフォールバック処理
- [ ] デバッグ情報の改善

### 🎯 Phase 1 成功基準
- [ ] **最低1機種の完全なモデル表示**
- [ ] **エラーなしでの3D表示**
- [ ] **適切なスケーリングと座標変換**
- [ ] **コックピットビューの基本表示**

### ⏱️ 見積工数
**2-3日** (16-24時間)

---

## Phase 2: DNMファイル基本対応 📊

**目標**: DNMファイルの標準的な機能を完全サポート

### 📋 Phase 2 タスク

#### 2.1 DNMファイル構造の完全対応
- [ ] 全DNMコマンド（POS、ATT、CLA等）のサポート
- [ ] 色情報（16bit RGB）の正確な処理
- [ ] 頂点の詳細属性（Round頂点等）の活用

#### 2.2 階層構造とトランスフォーメーション
- [ ] SRFセクションの階層関係処理
- [ ] 位置・回転変換の実装
- [ ] 複数パーツの統合処理

#### 2.3 マテリアルシステムの拡張
- [ ] 機体パーツ別のマテリアル設定
- [ ] 反射・透明度等の物理ベースレンダリング
- [ ] テクスチャマッピングの準備

#### 2.4 LOD（Level of Detail）システム
- [ ] Coarseモデルの活用
- [ ] 距離ベースのLOD切り替え
- [ ] パフォーマンス最適化

### 🎯 Phase 2 成功基準
- [ ] **5-10機種の安定した表示**
- [ ] **LODシステムの動作確認**
- [ ] **パフォーマンス：60FPS維持**
- [ ] **視覚的品質の向上**

### ⏱️ 見積工数
**4-5日** (32-40時間)

---

## Phase 3: PCK形式段階的対応 🔧

**目標**: 埋め込み表面データ（PCK形式）の完全サポート

### 📋 Phase 3 タスク

#### 3.1 PCK抽出エンジンの実装
- [ ] DNMファイルからのPCKセクション抽出
- [ ] 仮想ファイルシステムの構築
- [ ] 185個の番号付きSRFファイルの処理

#### 3.2 表面データキャッシュシステム
- [ ] 解析済みPCKデータの永続化
- [ ] メモリ効率的な管理
- [ ] ガベージコレクション対応

#### 3.3 複雑な機体モデルの対応
- [ ] 軍用機（F-22、F-18等）の表示
- [ ] 大型機（B-747、B-777等）の最適化
- [ ] 特殊機能（VTOL、可変翼等）の初期対応

#### 3.4 エラー処理の堅牢性向上
- [ ] 部分的なファイル破損への対応
- [ ] 段階的品質低下（graceful degradation）
- [ ] 詳細なエラーレポート機能

### 🎯 Phase 3 成功基準
- [ ] **全147機種のファイル解析完了**
- [ ] **PCK形式機体の正常表示**
- [ ] **メモリ使用量：1GB以下**
- [ ] **複雑な機体の安定表示**

### ⏱️ 見積工数
**6-8日** (48-64時間)

---

## Phase 4: WebAssembly統合 ⚡

**目標**: 既存WASM機能の活用とパフォーマンス最適化

### 📋 Phase 4 タスク

#### 4.1 WASM機能調査と統合
- [ ] `ysflight-core.wasm`のエクスポート関数解析
- [ ] DNM/SRF処理のWASM移行可能性評価
- [ ] JavaScript ↔ WASM間のデータ転送最適化

#### 4.2 パフォーマンス最適化
- [ ] 重い処理のWASM移行
- [ ] 並列処理の活用
- [ ] メモリプールの実装

#### 4.3 物理シミュレーション基盤
- [ ] 衝突判定システム
- [ ] 飛行力学の基本実装
- [ ] リアルタイム物理演算

#### 4.4 高度なレンダリング機能
- [ ] インスタンシング（編隊飛行）
- [ ] 影・反射効果
- [ ] 天候・環境エフェクト

### 🎯 Phase 4 成功基準
- [ ] **WASM統合によるパフォーマンス向上**
- [ ] **基本的な物理シミュレーション**
- [ ] **50機同時表示が可能**
- [ ] **視覚的品質の大幅向上**

### ⏱️ 見積工数
**5-7日** (40-56時間)

---

## Phase 5: 完全YSFLIGHT互換性 🎖️

**目標**: オリジナルYSFLIGHTとの完全互換性達成

### 📋 Phase 5 タスク

#### 5.1 高度なアニメーション機能
- [ ] 可動パーツ（ランディングギア、フラップ等）
- [ ] プロペラ・ローター回転
- [ ] コントロールサーフェスの動作

#### 5.2 完全なシーナリー対応
- [ ] 地形データの読み込み
- [ ] 空港・建物の表示
- [ ] 環境テクスチャの実装

#### 5.3 マルチプレイヤー基盤
- [ ] ネットワーク同期システム
- [ ] 複数機体の管理
- [ ] 通信プロトコルの実装

#### 5.4 ユーザビリティの完成
- [ ] 完全なUI/UXシステム
- [ ] 設定保存・読み込み
- [ ] カスタム機体のサポート

### 🎯 Phase 5 成功基準
- [ ] **オリジナルYSFLIGHTの全機能をWebで再現**
- [ ] **60FPS以上の安定動作**
- [ ] **マルチプレイヤー対応**
- [ ] **完全なユーザビリティ**

### ⏱️ 見積工数
**8-10日** (64-80時間)

---

## 📊 総合スケジュール

| フェーズ | 期間 | 累積工数 | 主要成果物 |
|---------|-----|---------|------------|
| Phase 1 | 2-3日 | 2-3日 | MVP：最初の動作確認 |
| Phase 2 | 4-5日 | 6-8日 | 標準DNM機能完成 |
| Phase 3 | 6-8日 | 12-16日 | PCK形式完全対応 |
| Phase 4 | 5-7日 | 17-23日 | WASM統合・高性能化 |
| Phase 5 | 8-10日 | 25-33日 | 完全YSFLIGHT互換 |

**総工数見積**: **25-33日** (200-264時間)

---

## 🎯 各フェーズのマイルストーン

### Phase 1 Milestone: "First Flight"
- 最初の機体がWebブラウザで正常表示
- 基本的な3D操作（回転、ズーム）が可能
- エラーなしでの動作

### Phase 2 Milestone: "Squadron Ready"
- 10機種以上の安定表示
- LODシステムの動作
- 60FPS安定動作

### Phase 3 Milestone: "Full Fleet"
- 全機種の表示対応
- PCK形式の完全解析
- 複雑な軍用機の表示

### Phase 4 Milestone: "High Performance"
- WASM統合完了
- 50機同時表示
- 物理シミュレーション基盤

### Phase 5 Milestone: "YSFLIGHT Web"
- 完全互換性達成
- マルチプレイヤー対応
- 製品レベル品質

---

## 🔗 依存関係とブロッカー

### 既解決
- ✅ **Issue #1**: YSFLIGHTリソース構造調査 → 完了

### Phase 1 → Phase 2
- **Blocker**: SRFパーサーの完成
- **Dependency**: 最低1機種の動作確認

### Phase 2 → Phase 3
- **Blocker**: DNM基本機能の安定化
- **Dependency**: LODシステムの実装

### Phase 3 → Phase 4
- **Blocker**: PCK抽出の完全実装
- **Dependency**: 全機種対応の完了

### Phase 4 → Phase 5
- **Blocker**: WASM統合の成功
- **Dependency**: パフォーマンス基準の達成

---

## 📈 成功指標とKPI

### 開発効率指標
- **バグ修正率**: 各フェーズで90%以上
- **コードカバレッジ**: 80%以上維持
- **ビルド成功率**: 95%以上

### パフォーマンス指標
- **フレームレート**: 60FPS以上
- **メモリ使用量**: ブラウザ1GB以下
- **初期ロード時間**: 5秒以下

### 品質指標
- **表示成功率**: 各フェーズで段階的向上
  - Phase 1: 1機種 100%
  - Phase 2: 10機種 95%
  - Phase 3: 147機種 90%
  - Phase 4: 147機種 95%
  - Phase 5: 147機種 99%

---

## 🛡️ リスク管理

### 高リスク要因
1. **WASM統合の複雑性** → プロトタイプで事前検証
2. **パフォーマンス問題** → 各フェーズでベンチマーク
3. **ブラウザ互換性** → クロスブラウザテスト

### 軽減策
- **段階的アプローチ**: 各フェーズで動作確認
- **フォールバック機能**: エラー時の代替処理
- **継続的インテグレーション**: 自動テスト・ビルド

---

## 🎉 結論

このロードマップにより、WebFlightは確実にMVPから完全なYSFLIGHT互換性まで段階的に発展できます。各フェーズは明確な成功基準を持ち、前のフェーズの成果を基盤として次に進む設計となっています。

特に**Phase 1**の早期達成が重要で、最初の動作確認により開発チーム・ユーザーの両方に大きな自信と動機を提供します。

**次のアクション**: Issue #2「既存SRFファイル用の基本パーサー実装」から開始することを強く推奨します。